<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SQL Injection Vulnerability Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='results_sql_injection.css') }}">
</head>
<body>
    <h1>SQL Injection Vulnerability Reports</h1>

    {% for item in results %}
    <div class="report">
        <h2>URL: {{ item.url }}</h2>
        {% if item.is_vulnerable %}
        <div class="overview">
            <p><strong>Parameter:</strong> {{ item.vulns_found.parameter }}, <strong>Method:</strong> {{ item.vulns_found.method }}</p>
            <p class="insight">
                {% if item.vulns_found.method == 'POST' %}
                Insight: The vulnerability likely stems from a form submission.
                {% elif item.vulns_found.method == 'GET' %}
                Insight: The vulnerability is likely in the URL parameters.
                {% endif %}
            </p>
        </div>
        <div class="findings">
            <h3>Findings</h3>
            {% for sqli_type in item.vulns_found.sqli_types %}
            <div>
                <h4>SQLi Type: {{ sqli_type.type }}</h4>
                <p><strong>Title:</strong> {{ sqli_type.title }}</p>
                <p><strong>Payload Used:</strong> {{ sqli_type.payload }}</p>
            </div>
            {% endfor %}
        </div>
        <div class="fix-guide">
            <h3>How to Fix</h3>
            {% if item.vulns_found.method == 'POST' %}
            <p class="fix-example">Use parameterized queries for POST data:</p>
            <div class="tab">
                <button class="tablinks" onclick="openLang(event, 'Python')">Python</button>
                <button class="tablinks" onclick="openLang(event, 'PHP')">PHP</button>
            </div>
            <div id="PHP" class="tabcontent">
                <pre>
// Vulnerable Example
$username = $_POST['{{ item.vulns_found.parameter }}'];
$query = "SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = '${{ item.vulns_found.parameter }}'";
$result = mysqli_query($connection, $query);

// Secure Example
$stmt = $pdo->prepare("INSERT INTO users ({{ item.vulns_found.parameter }}) VALUES (?)");
$stmt->execute([$_POST['{{ item.vulns_found.parameter }}']]);
                </pre>
              </div>
              <div id="Python" class="tabcontent">
                <pre>
// Vulnerable Example
query = f"SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = '{ {{ item.vulns_found.parameter }} }'"
cursor.execute(query)
results = cursor.fetchall()

// Secure Example
query = "INSERT INTO users ({{ item.vulns_found.parameter }}) VALUES (%s)"
cursor.execute(query, (form_data['{{ item.vulns_found.parameter }}'],))
                </pre>
              </div>


            {% elif item.vulns_found.method == 'GET' %}
            <p class="fix-example">Sanitize and validate GET parameters:</p>
            <div class="tab">
                <button class="tablinks" onclick="openLang(event, 'PythonGET')">Python</button>
                <button class="tablinks" onclick="openLang(event, 'PHPGET')">PHP</button>
            </div>
            <div id="PHPGET" class="tabcontent">
                <pre>
// Vulnerable Example
$username = $_POST['{{ item.vulns_found.parameter }}'];
$query = "SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = '${{ item.vulns_found.parameter }}'";
$result = mysqli_query($connection, $query);

// Secure Example
${{ item.vulns_found.parameter }} = filter_input(INPUT_GET, '{{ item.vulns_found.parameter }}', FILTER_SANITIZE_NUMBER_INT);
$stmt = $pdo->prepare("SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = ?");
$stmt->execute([${{ item.vulns_found.parameter }}]);
                </pre>
              </div>
              <div id="PythonGET" class="tabcontent">
                <pre>
// Vulnerable Example
{{ item.vulns_found.parameter }} = request.args.get('{{ item.vulns_found.parameter }}')
query = f"SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = '{ {{ item.vulns_found.parameter }} }'"
conn = sqlite3.connect('database.db')
cursor = conn.cursor()
cursor.execute(query)
results = cursor.fetchall()

// Secure Example
{{ item.vulns_found.parameter }} = request.args.get('{{ item.vulns_found.parameter }}', type=int)
query = "SELECT * FROM users WHERE {{ item.vulns_found.parameter }} = %s"
cursor.execute(query, ({{ item.vulns_found.parameter }},))
                </pre>
              </div>

            {% endif %}
        </div>
        {% else %}
        <p>No SQL Injection vulnerabilities found.</p>
        {% endif %}
    </div>
    {% endfor %}

    <script>
        function openLang(evt, cityName) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}
    </script>
</body>
</html>
