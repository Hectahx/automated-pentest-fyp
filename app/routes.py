from flask import render_template, redirect, url_for, session, Blueprint, request, flash
from .models import User, ScanResult
from .extensions import db
from flask_login import LoginManager, current_user, login_user, logout_user, login_required
import json


main_bp = Blueprint('main', __name__, template_folder='templates')


@main_bp.route('/', methods=['GET'])
def index():
    '''
    if "user_id" not in session:
        return redirect(url_for('auth.login'))
    '''
    return render_template("index.html", user=current_user)


@main_bp.route('/profile', methods=['GET'])
@login_required
def profile():
    scan_results = ScanResult.query.filter_by(user_id=current_user.id).order_by(ScanResult.scan_date.desc()).all()
    for scan in scan_results:
        try:
            scan.scan_data = json.loads(scan.scan_data)
        except TypeError as e:
            scan.scan_data = "hi"
    return render_template("profile.html", user=current_user, scan_results=scan_results)

@main_bp.route('/update-profile', methods=['POST'])
@login_required
def update_profile():
    username = request.form.get('username')
    email = request.form.get('email')
    
    # Add validation here
    
    current_user.username = username
    current_user.email = email
    db.session.commit()
    flash('Your profile was updated successfully.', 'success')
    return redirect(url_for('main.profile'))