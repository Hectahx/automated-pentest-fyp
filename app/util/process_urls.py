import re
import requests
from bs4 import BeautifulSoup

def process_urls(urls):
    login_urls = []
    sql_lfi_idor_urls = []

    all_urls = {}
    
    login_pattern = re.compile(r'https?:\/\/[\w.-]+(?:\.[\w.-]+)+(?:\/[\w\-\._~:/?#\[\]@!$&\'()*+,;=]*)?(\/login|\/signin|\/login\.php|\/signin\.php)(\?[\w\-\._~:/?#\[\]@!$&\'()*+,;=]*)?$')
    sql_lfi_pattern = re.compile(r'https?:\/\/[\w.-]+(?:\.[\w.-]+)+[\w\-\._~:/?#\[\]@!$&\'()*+,;=]*(\?|&)([\w.-]+=[\w.-]+)')
    sql_lfi_idor_urls = [url for url in urls if sql_lfi_pattern.search(url)]
    login_urls = [url for url in urls if login_pattern.search(url)]
    form_urls = [url for url in urls if has_form(url)]

    
    other_urls = [url for url in urls if not (login_pattern.search(url) or sql_lfi_pattern.search(url)) ]

    all_urls["login_forms"] = list(dict.fromkeys(login_urls + form_urls))
    all_urls["sql_lfi_idor"] = filter_unique_url_ids(sql_lfi_idor_urls)
    all_urls["other"] = other_urls

    print("URLs Processed") 
    return all_urls

def filter_unique_url_ids(urls):
    unique_urls = {}
    for url in urls:
        # Split the URL at the '?'
        base_url, query_string = url.split('?')
        # Use the combination of base URL and id as the key
        if base_url not in unique_urls:
            unique_urls[base_url] = url

    # Now get the list of unique URLs
    unique_urls_list = list(unique_urls.values())

    return(unique_urls_list)

def has_form(url):
    try:
        response = requests.get(url, timeout=10)  # Fetch the URL
        if response.status_code == 200:
            soup = BeautifulSoup(response.text, 'html.parser')
            return bool(soup.find('form'))  # Returns True if any form is found, else False
    except requests.RequestException:
        return False  # In case of a request error, assume no form
    return False

if __name__ == "__main__":
    urls = ["http://192.168.124.132/login/post.php?id=9", "http://192.168.124.132/login/post.php?id=9", "http://192.168.124.132/login/posts.php", "http://192.168.124.132/login/login.php"]
    print(process_urls(urls))