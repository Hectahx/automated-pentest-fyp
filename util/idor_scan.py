import aiohttp
import asyncio
import random
import re

async def fetch_content(session, url, new_id):
    # Replace the ID in the URL
    updated_url = re.sub(r'(?<=id=)\d+', str(new_id), url, 1)
    async with session.get(updated_url) as response:
        return await response.text()

async def check_idor(full_url):
    # Extract the current ID from the URL
    current_id = re.search(r'(?<=id=)\d+', full_url)
    if not current_id:
        return {"url": full_url, "is_vulnerable": False, "message": "No ID detected in URL"}

    current_id = current_id.group(0)

    async with aiohttp.ClientSession() as session:
        known_content = await fetch_content(session, full_url, current_id)

        random_contents = []
        for _ in range(3):
            random_id = random.randint(1, 100)  # Assuming ID is a number between 1 and 100
            #print(random_id)
            content = await fetch_content(session, full_url, random_id)
            random_contents.append(content)

        # Check if all random contents are the same and different from the known content
        if all(content == random_contents[0] for content in random_contents) and known_content != random_contents[0]:
            return {"url": full_url, "is_vulnerable": False, "message": "No IDOR Detected"}
        else:
            return {"url": full_url, "is_vulnerable": True, "message": "Potential IDOR Detected"}

# Example usage
async def main():
    full_url = "http://192.168.124.132/login/post.php?id=40"  # Full URL with ID
    result = await check_idor(full_url)
    print(result)

if __name__ == "__main__":
    asyncio.run(main())
